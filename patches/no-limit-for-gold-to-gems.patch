Author: aszlig <aszlig@nix.build>
Date:   Fri Mar 30 02:41:52 2018 +0200

    Don't limit the amount of gems that can be bought
    
    Everybody has a free lifetime subscription, so there really is no reason
    to limit the amount of gems that can be bought.
    
    I assume limit was originally introduced only because people bought a
    subscription, got a lot of gems and then cancelled the payment of the
    subscription.
    
    So this really isn't something that we have to defend against :-)
    
    Signed-off-by: aszlig <aszlig@nix.build>
    Filename: no-limit-for-gold-to-gems.patch

diff --git a/test/common/ops/buy/buyGem.js b/test/common/ops/buy/buyGem.js
index 4ae96a55b..22b15739b 100644
--- a/test/common/ops/buy/buyGem.js
+++ b/test/common/ops/buy/buyGem.js
@@ -102,19 +102,6 @@ describe('shared.ops.buyGem', () => {
         }
       });
 
-      it('prevents user that have reached the conversion cap from buying gems', (done) => {
-        user.stats.gp = goldPoints;
-        user.purchased.plan.gemsBought = gemsBought;
-
-        try {
-          buyGem(user, {params: {type: 'gems', key: 'gem'}});
-        } catch (err) {
-          expect(err).to.be.an.instanceof(NotAuthorized);
-          expect(err.message).to.equal(i18n.t('reachedGoldToGemCap', {convCap: planGemLimits.convCap}));
-          done();
-        }
-      });
-
       it('prevents user from buying an invalid quantity', (done) => {
         user.stats.gp = goldPoints;
         user.purchased.plan.gemsBought = gemsBought;
diff --git a/website/client/components/shops/buyModal.vue b/website/client/components/shops/buyModal.vue
index 0465becff..e1c78f7be 100644
--- a/website/client/components/shops/buyModal.vue
+++ b/website/client/components/shops/buyModal.vue
@@ -55,13 +55,6 @@
             span.svg-icon.inline.icon-32(aria-hidden="true", v-html="icons[getPriceClass()]")
             span.cost(:class="getPriceClass()") {{ item.value }}
 
-        .gems-left(v-if='item.key === "gem"')
-          strong(v-if='gemsLeft > 0') {{ gemsLeft }} {{ $t('gemsRemaining') }}
-          strong(v-if='gemsLeft === 0') {{ $t('maxBuyGems') }}
-
-        div(v-if='attemptingToPurchaseMoreGemsThanAreLeft')
-          | {{$t('notEnoughGemsToBuy')}}
-
         button.btn.btn-primary(
           @click="purchaseGems()",
           v-if="getPriceClass() === 'gems' && !this.enoughCurrency(getPriceClass(), item.value * selectedAmountToBuy)"
@@ -70,7 +63,6 @@
         button.btn.btn-primary(
           @click="buyItem()",
           v-else,
-          :disabled='item.key === "gem" && gemsLeft === 0 || attemptingToPurchaseMoreGemsThanAreLeft',
           :class="{'notEnough': !preventHealthPotion || !this.enoughCurrency(getPriceClass(), item.value * selectedAmountToBuy)}"
         ) {{ $t('buyNow') }}
 
@@ -248,16 +240,11 @@
 
       margin: 10px 0 24px;
     }
-
-    .gems-left {
-      margin-top: .5em;
-    }
   }
 </style>
 
 <script>
   import spellsMixin from 'client/mixins/spells';
-  import planGemLimits from 'common/script/libs/planGemLimits';
 
   import svgClose from 'assets/svg/close.svg';
   import svgGold from 'assets/svg/gold.svg';
@@ -346,14 +333,6 @@
       limitedString () {
         return this.$t('limitedOffer', {date: moment(seasonalShopConfig.dateRange.end).format('LL')});
       },
-      gemsLeft () {
-        if (!this.user.purchased.plan) return 0;
-        return planGemLimits.convCap + this.user.purchased.plan.consecutive.gemCapExtra - this.user.purchased.plan.gemsBought;
-      },
-      attemptingToPurchaseMoreGemsThanAreLeft () {
-        if (this.item && this.item.key && this.item.key === 'gem' && this.selectedAmountToBuy > this.gemsLeft) return true;
-        return false;
-      },
       notEnoughCurrency () {
         return !this.enoughCurrency(this.getPriceClass(), this.item.value * this.selectedAmountToBuy);
       },
diff --git a/website/client/components/shops/market/index.vue b/website/client/components/shops/market/index.vue
index 017101540..8869b09c8 100644
--- a/website/client/components/shops/market/index.vue
+++ b/website/client/components/shops/market/index.vue
@@ -145,7 +145,6 @@
             @click="itemSelected(item)"
           )
             span(slot="popoverContent")
-              strong(v-if='item.key === "gem" && gemsLeft === 0') {{ $t('maxBuyGems') }}
               h4.popover-content-title {{ item.text }}
             template(slot="itemBadge", slot-scope="ctx")
               countBadge(
@@ -153,8 +152,6 @@
                 :show="userItems[item.purchaseType][item.key] != 0",
                 :count="userItems[item.purchaseType][item.key] || 0"
               )
-              .badge.badge-pill.badge-purple.gems-left(v-if='item.key === "gem"')
-                | {{ gemsLeft }}
               span.badge.badge-pill.badge-item.badge-svg(
                 :class="{'item-selected-badge': ctx.item.pinned, 'hide': !ctx.item.pinned}",
                 @click.prevent.stop="togglePinned(ctx.item)"
@@ -332,11 +329,6 @@
     }
   }
 
-  .market .gems-left {
-    right: -.5em;
-    top: -.5em;
-  }
-
   @media only screen and (max-width: 768px) {
     .featuredItems .content {
       display: none !important;
@@ -382,7 +374,6 @@
   import getItemInfo from 'common/script/libs/getItemInfo';
   import isPinned from 'common/script/libs/isPinned';
   import shops from 'common/script/libs/shops';
-  import planGemLimits from 'common/script/libs/planGemLimits';
 
   import _filter from 'lodash/filter';
   import _sortBy from 'lodash/sortBy';
@@ -572,10 +563,6 @@ export default {
           },
         ];
       },
-      gemsLeft () {
-        if (!this.user.purchased.plan) return 0;
-        return planGemLimits.convCap + this.user.purchased.plan.consecutive.gemCapExtra - this.user.purchased.plan.gemsBought;
-      },
     },
     methods: {
       getClassName (classType) {
diff --git a/website/common/script/ops/buy/buyGem.js b/website/common/script/ops/buy/buyGem.js
index de1b9c6b6..0c41236b2 100644
--- a/website/common/script/ops/buy/buyGem.js
+++ b/website/common/script/ops/buy/buyGem.js
@@ -29,12 +29,6 @@ export class BuyGemOperation extends AbstractGoldItemOperation {
     let key = this.key = get(req, 'params.key');
     if (!key) throw new BadRequest(this.i18n('missingKeyParam'));
 
-    let convCap = planGemLimits.convCap;
-    convCap += user.purchased.plan.consecutive.gemCapExtra;
-
-    // todo better name?
-    this.convCap = convCap;
-
     this.canUserPurchase(user);
   }
 
@@ -44,17 +38,6 @@ export class BuyGemOperation extends AbstractGoldItemOperation {
     }
 
     super.canUserPurchase(user, item);
-
-    if (user.purchased.plan.gemsBought >= this.convCap) {
-      throw new NotAuthorized(this.i18n('reachedGoldToGemCap', {convCap: this.convCap}));
-    }
-
-    if (user.purchased.plan.gemsBought + this.quantity > this.convCap) {
-      throw new NotAuthorized(this.i18n('reachedGoldToGemCapQuantity', {
-        convCap: this.convCap,
-        quantity: this.quantity,
-      }));
-    }
   }
 
   executeChanges (user, item) {
