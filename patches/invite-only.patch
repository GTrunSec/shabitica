Author: aszlig <aszlig@nix.build>
Date:   Tue Mar 27 05:37:13 2018 +0200

    Only allow users with a valid invitation link
    
    We don't want everybody to create accounts on this instance but only
    selected users we explicitly invite, so let's remove the registration
    form from the home page and only show it whenever the user directly
    follows an invitation URL.
    
    Signed-off-by: aszlig <aszlig@nix.build>
    Filename: invite-only.patch

diff --git a/website/client/components/static/home.vue b/website/client/components/static/home.vue
index c62194c5c..eef10bf75 100644
--- a/website/client/components/static/home.vue
+++ b/website/client/components/static/home.vue
@@ -5,7 +5,7 @@
       a(href='http://www.enable-javascript.com/', target='_blank') {{ $t('jsDisabledLink') }}
 
     #intro-signup.purple-1
-      .container
+      .container(v-if='invited')
         .row
           .col-12.col-sm-6.col-md-6.col-lg-6
             img(src='~assets/images/home/home-main@3x.png', width='357px')
@@ -23,6 +23,12 @@
               button.sign-up(@click="register()") {{$t('signup')}}
           .col-12
             .spacer.svg-icon(v-html='icons.spacer')
+      .container(v-if='!invited')
+        img(src='~assets/images/home/home-main@3x.png', width='357px')
+        h1 {{$t('motivateYourself')}}
+        p.section-main {{$t('timeToGetThingsDone')}}
+        .col-12
+          .spacer.svg-icon(v-html='icons.spacer')
 
     #gamify-life.purple-2
       .container-fluid
@@ -499,6 +505,17 @@
         if (this.passwordConfirm.length <= 3) return false;
         return this.passwordConfirm !== this.password;
       },
+      invited () {
+        let groupInvite = '';
+        if (this.$route.query && this.$route.query.p) {
+          groupInvite = this.$route.query.p;
+        }
+
+        if (this.$route.query && this.$route.query.groupInvite) {
+          groupInvite = this.$route.query.groupInvite;
+        }
+        return Boolean(groupInvite);
+      },
     },
     methods: {
       validateEmail (email) {
diff --git a/website/server/controllers/api-v3/auth.js b/website/server/controllers/api-v3/auth.js
index 34b3849a8..041376e39 100644
--- a/website/server/controllers/api-v3/auth.js
+++ b/website/server/controllers/api-v3/auth.js
@@ -60,7 +60,9 @@ async function _handleGroupInvitation (user, invite) {
     }
   } catch (err) {
     logger.error(err);
+    return false;
   }
+  return true;
 }
 
 /**
@@ -150,7 +152,11 @@ api.registerLocal = {
 
     // we check for partyInvite for backward compatibility
     if (req.query.groupInvite || req.query.partyInvite) {
-      await _handleGroupInvitation(newUser, req.query.groupInvite || req.query.partyInvite);
+      let success = await _handleGroupInvitation(newUser, req.query.groupInvite || req.query.partyInvite);
+      if (!success)
+        throw new NotAuthorized(res.t('inviteOnly'));
+    } else {
+      throw new NotAuthorized(res.t('inviteOnly'));
     }
 
     let savedUser = await newUser.save();
